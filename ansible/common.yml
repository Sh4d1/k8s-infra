---
- name: Prepare nodes
  hosts: [all]
  gather_facts: true
  tags:
    - common
    - all
  roles:
    - { role: common, task: conf }
    - { role: common, task: packages }
    - { role: common, task: ntp, tags: ntp }
    - { role: common, task: resolv, tags: resolv }

- name: Servers
  hosts: all
  tags:
    - tailscale
  roles:
    - role: artis3n.tailscale
      vars:
        tailscale_args: "--accept-routes --accept-dns=false"
        tailscale_auth_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36343939646565303462646538396331646237353132613738383836643865373833373466373564
          6332613431353436376231323333323832396661653931330a643064613165363164396435363865
          31303763333036366661336430383634646136333835613234356638626561323338353039353965
          3037343730336530650a613938656664613132616261396339613032326239323462326465383839
          38323637303839653662623563363933633062303861356665313134313361316132

- name: Fix dns
  hosts: [all]
  gather_facts: true
  tags:
    - tailscale
  roles:
    - { role: common, task: resolv, tags: resolv }

- name: Clear gathered facts
  hosts: [all]
  tasks:
    - meta: clear_facts

- name: Refresh inventory
  hosts: [all]
  tasks:
    - meta: refresh_inventory

- name: Regather facts
  hosts: [all]
  gather_facts: true
  tags:
    - common
